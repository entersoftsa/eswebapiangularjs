!function(){"use strict";function a(a,b){return-1!==a.indexOf(b,a.length-b.length)}function b(a,b){return 0===a.toLowerCase().indexOf(b.toLowerCase())}var c=angular.module("es.Services.Web",["ngStorage","ngSanitize"]);c.constant("ESWEBAPI_URL",{__LOGIN__:"api/Login",__PUBLICQUERY__:"api/rpc/PublicQuery/",__USERSITES__:"api/Login/Usersites",__SCROLLERROOTTABLE__:"api/rpc/SimpleScrollerRootTable/",__SCROLLER__:"api/rpc/SimpleScroller/",__ENTITYACTION__:"api/Entity/",__ENTITYBYGIDACTION__:"api/EntityByGID/",__ELASTICSEARCH__:"api/esearch/",__SERVER_CAPABILITIES__:"api/Login/ServerCapabilities/",__REGISTER_EXCEPTION__:"api/rpc/registerException/",__FETCH_COMPANY_PARAM__:"api/rpc/FetchCompanyParam/",__FETCH_COMPANY_PARAMS__:"api/rpc/FetchCompanyParams/",__SCROLLER_COMMAND__:"api/rpc/ScrollerCommand/",__FORM_COMMAND__:"api/rpc/FormCommand/"}),c.value("__WEBAPI_RT__",{url:""}),c.provider("es.Services.WebApi",function(){var c="",d="",e="",f={host:"",allowUnsecureConnection:!1,subscriptionId:"",subscriptionPassword:""};return{getSettings:function(){return f},getServerUrl:function(){return c},setSettings:function(g){var h="https://",i="http://";if(f=g,!f.host)throw"host for Entersoft WEB API Server is not specified";if(f.host=f.host.trim(),b(f.host,h)?f.host=f.host.slice(h.length).trim():b(f.host,i)&&(f.host=f.host.slice(i.length).trim()),""==f.host)throw"host for Entersoft WEB API Server is not specified";return a(f.host,"/")||(f.host+="/"),d=i+f.host,e=h+f.host,c=f.allowUnsecureConnection?d:e,this},$get:["$http","$log","$q","$rootScope","ESWEBAPI_URL","es.Services.Globals",function(a,b,g,h,i,j){function k(a,d){if(a){var e=angular.copy(a);try{e.__SubscriptionID=f.subscriptionId,e.__ServerUrl=c,e.__EDate=new Date,$.ajax({type:"POST",url:c.concat(i.__REGISTER_EXCEPTION__),contentType:"application/json",headers:{Authorization:j.getWebApiToken()},data:JSON.stringify({exceptionData:e,exceptionStore:d},null,"	")});var g=j.getGA();angular.isDefined(ga)&&g.registerException(e)}catch(h){b.warn("Error logging failed"),b.error(h)}}}function l(b){if(!b||!b.ScrollerID||!b.CommandID)throw"ScrollerID and CommandID properties must be defined";var c=i.__SCROLLER_COMMAND__,d=j.trackTimer("SCR","COMMAND",b.ScrollerID.concat("/",b.CommandID));d.startTime();var e=a({method:"post",headers:{Authorization:j.getWebApiToken()},url:c,data:b});return e.then(function(){d.endTime().send()}),e}function m(b){if(!b||!b.EntityID||!b.CommandID)throw"EntityID and CommandID properties must be defined";var c=i.__FORM_COMMAND__,d=j.trackTimer("FORM","COMMAND",b.EntityID.concat("/",b.CommandID));d.startTime();var e=a({method:"post",headers:{Authorization:j.getWebApiToken()},url:c,data:b});return e.then(function(){d.endTime().send()}),e}function n(b,d,e,f){var g=c.concat(b,d,"/",e),h=j.trackTimer("SCR","FETCH",d.concat("/",e));h.startTime();var i=a({method:"GET",headers:{Authorization:j.getWebApiToken()},url:g,params:f});return i.then(function(){h.endTime().send()}),i}return{getServerUrl:function(){return c},openSession:function(d){var e=j.trackTimer("AUTH","LOGIN","");return e.startTime(),a({method:"post",url:c+i.__LOGIN__,data:{SubscriptionID:f.subscriptionId,SubscriptionPassword:f.subscriptionPassword,Model:d}}).success(function(a){j.sessionOpened(a,d),e.endTime().send()}).error(function(a){j.sessionClosed(),a?b.error(a):console.log("Generic Http error")})},logout:function(){j.sessionClosed(),b.info("LOGOUT User")},fetchCompanyParam:function(b){if(!b)return void 0;var d=c.concat(i.__FETCH_COMPANY_PARAM__,b),e=a({method:"get",headers:{Authorization:j.getWebApiToken()},url:d});return e},fetchCompanyParams:function(b){var d;d=b?angular.isArray(b)?c+i.__FETCH_COMPANY_PARAMS__+b.join("/"):c+i.__FETCH_COMPANY_PARAMS__+b:c+i.__FETCH_COMPANY_PARAMS__;var e=a({method:"get",headers:{Authorization:j.getWebApiToken()},url:d});return e},registerException:k,fetchServerCapabilities:function(){var b=g.defer();return a.get(d+i.__SERVER_CAPABILITIES__).success(function(a){b.resolve(a)}).error(function(){a.get(e+i.__SERVER_CAPABILITIES__).success(function(a){b.resolve(a)}).error(function(a,c,d,e){b.reject([a,c,d,e])})}),b.promise},fetchScroller:function(a,b,c){return n(i.__SCROLLER__,a,b,c)},fetchSimpleScrollerRootTable:function(a,b,c){return n(i.__SCROLLERROOTTABLE__,a,b,c)},fetchUserSites:function(b){return a({method:"post",url:c+i.__USERSITES__,data:{SubscriptionID:f.subscriptionId,SubscriptionPassword:f.subscriptionPassword,Model:b}})},executeNewEntityAction:function(b,d,e){var f=c.concat(i.__ENTITYACTION__,b,"/",d),g=j.trackTimer("ACTION","NEW_ENTITY",b.concat("/",d));g.startTime();var h=a({method:"post",headers:{Authorization:j.getWebApiToken()},url:f,data:e});return h.then(function(){g.endTime().send()}),h},executeEntityActionByCode:function(b,d,e,f){var g=c.concat(i.__ENTITYACTION__,b,"/",d,"/",e),h=j.trackTimer("ACTION","ENTITY_CODE",b.concat("/",e));h.startTime();var k=a({method:"post",headers:{Authorization:j.getWebApiToken()},url:g,data:f});return k.then(function(){h.endTime().send()}),k},executeEntityActionByGID:function(b,d,e,f){var g=c.concat(i.__ENTITYBYGIDACTION__,b,"/",d,"/",e),h=j.trackTimer("ACTION","ENTITY_GID",b.concat("/",e));h.startTime();var k=a({method:"post",headers:{Authorization:j.getWebApiToken()},url:g,data:f});return k.then(function(){h.endTime().send()}),k},executeFormCommand:function(a){return m(a)},executeFormCommandDS:function(a,b,c,d){var e={EntityID:a,CommandID:b,CommandParams:c};return d&&(e.EntityDataset=d),m(e)},executeScrollerCommandSRV:function(a,b,c,d,e){var f={ScrollerID:a+"/"+b,CommandID:c,ScrollerParams:d,CommandParams:e};return l(f)},executeScrollerCommandDS:function(a,b,c,d,e){var f={ScrollerID:a+"/"+b,CommandID:c,ScrollerDataset:d,CommandParams:e};return l(f)},fetchPublicQuery:function(b,d,e,f){var g=c.concat(i.__PUBLICQUERY__,b,"/",d),h=j.trackTimer("PQ","FETCH",b.concat("/",d));h.startTime();var k={headers:{Authorization:j.getWebApiToken()},url:g,params:e};k.method=3===arguments.length?"GET":f,"GET"!==k.method&&(delete k.params,k.data=e);var l=a(k);return l.then(function(){h.endTime().send()}),l},eSearch:function(b,d,e){var f=c.concat(i.__ELASTICSEARCH__,b);return a({method:d,headers:{Authorization:j.getWebApiToken()},url:f,data:e}).success(function(){var a=j.getGA();angular.isDefined(ga)&&a.registerEventTrack({category:"ELASTIC_SEARCH",action:"SEARCH",label:b})}).error(function(a){try{k(a)}catch(b){}})}}}]}}),c.factory("es.Services.ElasticSearch",["es.Services.WebApi",function(a){return{searchIndex:function(b,c){var d=b+"/_search";return a.eSearch(d,"post",c)},searchIndexAndDocument:function(b,c,d){var e=b+"/"+c+"/_search";return a.eSearch(e,"post",d)},searchFree:a.eSearch}}])}(),function(){"use strict";var a=angular.module("underscore",[]);a.factory("_",function(){return window._});var b=angular.module("es.Services.Web");b.provider("es.Services.Cache",function(){var a=null,b={};return b.maxSize=-1,b.storage=null,{setMaxSize:function(a){angular.isNumber(a)&&(b.maxSize=a)},getMaxSize:function(){return b.maxSize},getStorageSettings:function(){return b.storage},setStorageSettings:function(){b&&(b.storage=b)},$get:function(){if("undefined"==typeof Cache)throw"You must include jscache.js";return a=new Cache(b.maxSize,!1,b.storage),{getItem:function(b){return a.getItem(b)},setItem:function(b,c,d){a.setItem(b,c,d)},removeItem:function(b){a.removeItem(b)},removeWhere:function(b){a.removeWhere(function(a,c){return b(a,c)})},size:function(){return a.size()},clear:function(){a.clear()},stats:function(){return a.stats()}}}}}),b.factory("es.Services.Messaging",function(){function a(){if(!arguments||arguments.Length<1)throw"Publishing events requires at least one argument for topic id";var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d[a]&&angular.forEach(d[a],function(c){try{c.apply(null,b)}catch(d){console.log("Error in messaging handler for topic ",a)}})}function b(a,b){return d[a]||(d[a]=[]),d[a].push(b),[a,b]}function c(a){var b=a[0];d[b]&&angular.forEach(d[b],function(c){this==a[1]&&d[b].splice(c,1)})}var d={},e={publish:a,subscribe:b,unsubscribe:c};return e}),b.factory("es.Services.Globals",["$sessionStorage","$log","es.Services.Messaging","$injector",function(a,b,c,d){function e(){if(!d)return void 0;try{return d.get("es.Services.GA")}catch(a){return void 0}}function f(){if(!j.connectionModel){var d=a,f=null;if("undefined"!=typeof d.__esrequest_sesssion&&null!==d.__esrequest_sesssion){f=d.__esrequest_sesssion,j.connectionModel=f,c.publish("AUTH_CHANGED",j,h(f));var g=e();angular.isDefined(g)&&g.registerEventTrack({category:"AUTH",action:"RELOGIN",label:j.connectionModel.GID}),b.info("RELOGIN User ",j.connectionModel.Name)}else c.publish("AUTH_CHANGED",null,h(null)),b.info("NO RELOGIN from stored state")}return j.connectionModel}function g(b){var d=null;if(j.connectionModel&&(d=j.connectionModel.GID),j.connectionModel=b,b)a.__esrequest_sesssion=b;else{delete a.__esrequest_sesssion;var f=e();angular.isDefined(f)&&f.registerEventTrack({category:"AUTH",action:"LOGOUT",label:d})}c.publish("AUTH_CHANGED",j,h(b))}function h(a){return a?"Bearer "+a.WebApiToken:""}function i(a,b,c){return this.category=a,this.variable=b,this.label=c?c:void 0,this.startTime,this.endTime,this}var j={hostUrl:"",credentials:null,connectionModel:null,getWebApiToken:function(){return h(f())},setModel:g,getModel:f};return i.prototype.startTime=function(){return this.startTime=(new Date).getTime(),this},i.prototype.endTime=function(){return this.endTime=(new Date).getTime(),this},i.prototype.send=function(){var a=this.endTime-this.startTime,b=e();return b?(b.registerTiming({timingCategory:this.category,timingVar:this.variable,timingValue:a,timingLabel:this.label}),this):void 0},{getGA:e,getWebApiToken:function(){return j.getWebApiToken()},getClientSession:function(){return j},sessionClosed:function(){j.setModel(null)},trackTimer:function(a,b,c){return new i(a,b,c)},sessionOpened:function(a,c){try{j.setModel(a.Model),j.credentials=c;var d=e();if(angular.isDefined(d)){var f;for(f=0;12>f;f++)angular.isDefined(d)&&d.registerEventTrack({category:"AUTH",action:"LOGIN",label:a.Model.GID})}b.info("LOGIN User ",a.Model.Name)}catch(g){throw b.error(g),g}}}}]),b.run(["es.Services.Globals","es.Services.WebApi",function(a,b){var c=a.getClientSession();c.getModel(),c.hostUrl=b.getServerUrl()}])}();
//# sourceMappingURL=eswebapi-angular-light.min.js.map